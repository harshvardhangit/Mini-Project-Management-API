package com.example.projectmanagement.controller;

import com.example.projectmanagement.dto.ProjectDto;
import com.example.projectmanagement.model.Project;
import com.example.projectmanagement.model.User;
import com.example.projectmanagement.repository.UserRepository;
import com.example.projectmanagement.service.ProjectService;
import jakarta.validation.Valid;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.web.bind.annotation.*;
import java.util.List;

@RestController
@RequestMapping("/projects")
public class ProjectController {
	@Autowired
	ProjectService projectService;

	@Autowired
	UserRepository userRepo;

	@PostMapping("/addproject")
	public Project create(@Valid @RequestBody ProjectDto dto, @AuthenticationPrincipal UserDetails userDetails) {
		Project p = new Project();
		p.setName(dto.getName());
		p.setDescription(dto.getDescription());
		return projectService.createProject(userDetails.getUsername(), p);
	}

	@GetMapping("/projectList")
	public List<Project> list(@AuthenticationPrincipal UserDetails userDetails) {
		return projectService.listByUser(userDetails.getUsername());
	}

	@PutMapping("updateproject/{id}")
	public Project update(@PathVariable Long id, @Valid @RequestBody ProjectDto dto,
			@AuthenticationPrincipal UserDetails userDetails) {
		User owner = userRepo.findByUsername(userDetails.getUsername()).orElseThrow();
		Project p = projectService.getByIdAndOwner(id, owner.getId());
		p.setName(dto.getName());
		p.setDescription(dto.getDescription());
		return projectService.createProject(userDetails.getUsername(), p); // save
	}

	@DeleteMapping("deleteProject/{id}")
	public void delete(@PathVariable Long id, @AuthenticationPrincipal UserDetails userDetails) {
		User owner = userRepo.findByUsername(userDetails.getUsername()).orElseThrow();
		Project p = projectService.getByIdAndOwner(id, owner.getId());
		projectService.delete(p);
	}

}
