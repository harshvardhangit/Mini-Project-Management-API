package com.example.projectmanagement.service;

import com.example.projectmanagement.dto.TaskDto;
import com.example.projectmanagement.model.Project;
import com.example.projectmanagement.model.Task;
import com.example.projectmanagement.model.User;
import com.example.projectmanagement.repository.ProjectRepository;
import com.example.projectmanagement.repository.TaskRepository;
import com.example.projectmanagement.repository.UserRepository;

import java.util.NoSuchElementException;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Service;

@Service
public class TaskService {
	@Autowired
	TaskRepository taskRepo;
	@Autowired
	ProjectRepository projectRepo;

	@Autowired
	private UserRepository userRepo;

	public Task createTaskForUser(Long projectId, TaskDto dto, String username) {
		User user = userRepo.findByUsername(username)
				.orElseThrow(() -> new NoSuchElementException("User not found with username: " + username));
		Project project = projectRepo.findById(projectId)
				.orElseThrow(() -> new NoSuchElementException("Project not found with id: " + projectId));
		if (!project.getOwner().getId().equals(user.getId())) {
			throw new RuntimeException("Unauthorized");
		}
		Task task = new Task();
		task.setTitle(dto.getTitle());
		task.setDescription(dto.getDescription());
		task.setPriority(dto.getPriority() == null ? Task.Priority.MEDIUM : dto.getPriority());
		task.setStatus(dto.getStatus() == null ? Task.Status.PENDING : dto.getStatus());
		task.setDueDate(dto.getDueDate());
		task.setProject(project);
		return taskRepo.save(task);
	}

	public Page<Task> getTasksForUser(Long projectId, String username, Integer pageNo, Integer pageSize, String sortBy,
			String orderBy) {

		User user = userRepo.findByUsername(username)
				.orElseThrow(() -> new NoSuchElementException("User not found with username: " + username));
		Project project = projectRepo.findById(projectId)
				.orElseThrow(() -> new NoSuchElementException("Project not found with id: " + projectId));
		if (!project.getOwner().getId().equals(user.getId()))
			throw new RuntimeException("Unauthorized");

		Sort by = null;
		if (orderBy.equals("ASC")) {
			by = Sort.by(sortBy).ascending();
		} else {
			by = Sort.by(sortBy).descending();
		}
		PageRequest of = PageRequest.of(pageNo, pageSize, by);
		return taskRepo.findByProjectId(projectId, of);
	}

	public Page<Task> searchByUser(Long ownerId, String q, Pageable pageable) {
		if (q == null || q.isBlank()) {
			return taskRepo.findByOwnerId(ownerId, pageable);
		}
		return taskRepo.searchByUserAndQuery(ownerId, q, pageable);
	}

	public Task updateTask(Long taskId, TaskDto dto, String username) {
		Task task = taskRepo.findById(taskId)
				.orElseThrow(() -> new NoSuchElementException("Task not found with id: " + taskId));
		if (!task.getProject().getOwner().getUsername().equals(username))
			throw new RuntimeException("Unauthorized");

		task.setTitle(dto.getTitle());
		task.setDescription(dto.getDescription());
		if (dto.getPriority() != null)
			task.setPriority(dto.getPriority());
		if (dto.getStatus() != null)
			task.setStatus(dto.getStatus());
		task.setDueDate(dto.getDueDate());
		return taskRepo.save(task);
	}

	public void deleteTask(Long taskId, String username) {
		Task task = taskRepo.findById(taskId)
				.orElseThrow(() -> new NoSuchElementException("Task not found with id: " + taskId));

		if (!task.getProject().getOwner().getUsername().equals(username))
			throw new RuntimeException("Unauthorized");
		taskRepo.delete(task);
	}

	public Page<Task> searchByUser(String search, Integer pageNo, Integer pageSize, String sortBy, String orderBy,
			String userName) {
		User user = userRepo.findByUsername(userName)
				.orElseThrow(() -> new NoSuchElementException("User not found with username: " + userName));

		Sort by = null;
		if (orderBy.equals("ASC")) {
			by = Sort.by(sortBy).ascending();
		} else {
			by = Sort.by(sortBy).descending();
		}
		PageRequest of = PageRequest.of(pageNo, pageSize, by);

		return searchByUserAndQuery(user.getId(),search,of);
	}

}
