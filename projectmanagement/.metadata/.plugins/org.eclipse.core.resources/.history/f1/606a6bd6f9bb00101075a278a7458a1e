package com.example.projectmanagement.controller;
import com.example.projectmanagement.dto.ProjectDto;
import com.example.projectmanagement.model.Project;
import com.example.projectmanagement.model.User;
import com.example.projectmanagement.repository.UserRepository;
import com.example.projectmanagement.service.ProjectService;
import jakarta.validation.Valid;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.web.bind.annotation.*;
import java.util.List;

@RestController
@RequestMapping("/projects")
public class ProjectController {
	
	 private final ProjectService projectService;
	    private final UserRepository userRepo;

	    public ProjectController(ProjectService projectService, UserRepository userRepo) {
	        this.projectService = projectService;
	        this.userRepo = userRepo;
	    }

	    @PostMapping
	    public Project create(@Valid @RequestBody ProjectDto dto, @AuthenticationPrincipal UserDetails userDetails) {
	        Project p = new Project();
	        p.setName(dto.getName());
	        p.setDescription(dto.getDescription());
	        return projectService.createProject(userDetails.getUsername(), p);
	    }

	    @GetMapping
	    public List<Project> list(@AuthenticationPrincipal UserDetails userDetails) {
	        return projectService.listByUser(userDetails.getUsername());
	    }

	    @PutMapping("/{id}")
	    public Project update(@PathVariable Long id, @Valid @RequestBody ProjectDto dto, @AuthenticationPrincipal UserDetails userDetails) {
	        User owner = userRepo.findByUsername(userDetails.getUsername()).orElseThrow();
	        Project p = projectService.getByIdAndOwner(id, owner.getId());
	        p.setName(dto.getName());
	        p.setDescription(dto.getDescription());
	        return projectService.createProject(userDetails.getUsername(), p); // save
	    }

	    @DeleteMapping("/{id}")
	    public void delete(@PathVariable Long id, @AuthenticationPrincipal UserDetails userDetails) {
	        User owner = userRepo.findByUsername(userDetails.getUsername()).orElseThrow();
	        Project p = projectService.getByIdAndOwner(id, owner.getId());
	        projectService.delete(p);
	    }

}
